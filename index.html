<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>做七登記</title>

  <!-- Tailwind CSS（CDN；正式可改為本地建置） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden-page { display: none !important; }
    .conn-dot { width: 10px; height: 10px; border-radius: 9999px; display: inline-block; vertical-align: middle; }
  </style>

  <script type="module">
    /**************************************************************
     * 1) 匯入 Firebase SDK
     **************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, addDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, getDocs, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /**************************************************************
     * 2) 右上角「連線狀態徽章」：僅在警告/錯誤時顯示文字
     **************************************************************/
    const chip = document.createElement("div");
    chip.id = "status-chip";
    chip.className = "fixed top-3 right-3 text-xs px-3 py-1 rounded-full text-white bg-gray-500 shadow cursor-default opacity-0 transition-opacity";
    chip.textContent = "啟動中…";
    document.addEventListener("DOMContentLoaded", () => {
      document.body.appendChild(chip);
    });
    function setChip(text, level = "info") {
      chip.textContent = text;
      chip.classList.remove("bg-gray-500","bg-sky-500","bg-green-600","bg-amber-500","bg-red-600","opacity-0");
      const cls = level === "ok" ? "bg-green-600" : level === "warn" ? "bg-amber-500" : level === "info" ? "bg-sky-500" : "bg-red-600";
      chip.classList.add(cls);
      // 僅在 warn/err 顯示；ok/info 則淡出
      if (level === "ok" || level === "info") {
        chip.classList.add("opacity-0");
      }
      console.log(`[status] ${text}`);
    }
    window.addEventListener("error", (e) => {
      setChip(`錯誤：${e.message}`, "err");
      setConnDot("err", "執行期錯誤");
      console.error(e);
    });
    window.addEventListener("unhandledrejection", (e) => {
      setChip(`錯誤：${e.reason}`, "err");
      setConnDot("err", "未處理的 Promise 拒絕");
      console.error(e);
    });

    /**************************************************************
     * 3) Firebase 設定：Canvas 優先，否則 fallback 固定專案
     **************************************************************/
    let firebaseConfig = null;
    try {
      if (typeof __firebase_config !== "undefined" && __firebase_config) {
        firebaseConfig = JSON.parse(__firebase_config);
        console.log("[config] 來自 __firebase_config。");
      }
    } catch (err) {
      console.error("[config] 解析 __firebase_config 失敗：", err);
    }
    if (!firebaseConfig) {
      firebaseConfig = {
        apiKey: "AIzaSyCgdP0_UH9RlprxBriBXvpPrOFYsJo3aFg",
        authDomain: "servicelogs-8577c.firebaseapp.com",
        projectId: "servicelogs-8577c",
        storageBucket: "servicelogs-8577c.firebasestorage.app",
        messagingSenderId: "772814177521",
        appId: "1:772814177521:web:448ed90ebfbd2baf769550"
      };
      console.log("[config] 使用 fallback 固定設定。");
    }
    const appId = firebaseConfig?.projectId || "servicelogs-8577c";

    /**************************************************************
     * 4) 初始化 Firebase + Auth
     **************************************************************/
    let db, auth;
    let currentUserId = null;
    let currentDeceasedId = null;
    let deceasedUnsubscribe = null;
    let attendanceUnsubscribe = null;

    // 供「小綠燈」使用
    let connDotEl = null;
    function setConnDot(level = "info", title = "") {
      if (!connDotEl) return;
      connDotEl.title = title || connDotEl.title || "";
      connDotEl.classList.remove("bg-gray-400","bg-sky-500","bg-green-600","bg-amber-500","bg-red-600");
      connDotEl.classList.add(level === "ok" ? "bg-green-600"
        : level === "warn" ? "bg-amber-500"
        : level === "info" ? "bg-sky-500"
        : "bg-red-600");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      connDotEl = document.getElementById("conn-dot");
      setConnDot("warn", "初始化中…");

      try {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        setLogLevel("debug");
        setChip("初始化完成", "info");
        setConnDot("warn", "初始化完成，等待登入…");
      } catch (e) {
        setChip("初始化失敗", "err");
        setConnDot("err", "初始化失敗");
        console.error("[init] 失敗：", e);
        return;
      }
      setupDomRefs();
      setupEventListeners();
      setupAuthListener();
      // 啟動後主動測一次讀取（不依賴按鈕）
      testConnectionOnce();
    });

    async function setupAuthListener() {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUserId = user.uid;
          setChip("已登入（匿名）", "ok");
          setConnDot("ok", "已登入（匿名）");
          await loadDeceasedList();
        } else {
          setChip("登入中…", "warn");
          setConnDot("warn", "登入中…");
          try {
            if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
              setChip("已登入（自訂 Token）", "ok");
              setConnDot("ok", "已登入（自訂 Token）");
            } else {
              await signInAnonymously(auth);
              setChip("已登入（匿名）", "ok");
              setConnDot("ok", "已登入（匿名）");
            }
          } catch (err) {
            setChip(`登入失敗：${err?.message || err}`, "err");
            setConnDot("err", "登入失敗");
            console.error("[auth] 登入失敗：", err);
          }
        }
      });
    }

    /**************************************************************
     * 5) Firestore 路徑（固定以 projectId 建構）
     **************************************************************/
    function getDeceasedCollectionPath() {
      return `artifacts/${appId}/public/data/deceased`;
    }
    function getAttendanceCollectionPath(deceasedId) {
      return `artifacts/${appId}/public/data/deceased/${deceasedId}/attendance`;
    }

    /**************************************************************
     * 6) DOM 參照
     **************************************************************/
    let pageList, pageAddDeceased, pageDetails, pageEditDeceased;
    let deceasedList, loadingIndicator, addDeceasedFab, exportButton, exportLoadingIndicator;
    let addDeceasedForm;
    let deceasedNameInput, deceasedDateInput, deceasedReferrerInput, deceasedSourceSelect, deceasedSourceNotesInput;
    let deceasedApplicantNameInput, deceasedApplicantRelInput;
    let deceasedContactNameInput, deceasedContactRelInput, deceasedContactPhoneInput;
    let deceasedChantDateInput, deceasedChantTimeInput, deceasedChantLocationInput;
    let deceasedRemarksInput;
    let deceasedNotifyHundredInput, deceasedNotifyYear1Input, deceasedNotifyYear3Input;
    let deceasedAttendedHundredInput, deceasedAttendedYear1Input, deceasedAttendedYear3Input;
    let detailsDeceasedName, detailsDeceasedDate, detailsDeceasedReferrer, detailsDeceasedSource, detailsDeceasedSourceNotes;
    let detailsApplicant, detailsContact, detailsContactPhone, detailsChantDateTime, detailsChantLocation, detailsRemarks;
    let detailsNotify, detailsAttended, editDeceasedButton;
    let addAttendanceForm, attendanceFamilyNameInput, attendanceTypeSelect, attendanceDateInput, attendanceList;
    let editDeceasedForm;
    let editDeceasedNameInput, editDeceasedDateInput, editDeceasedReferrerInput, editDeceasedSourceSelect, editDeceasedSourceNotesInput;
    let editDeceasedApplicantNameInput, editDeceasedApplicantRelInput;
    let editDeceasedContactNameInput, editDeceasedContactRelInput, editDeceasedContactPhoneInput;
    let editDeceasedChantDateInput, editDeceasedChantTimeInput, editDeceasedChantLocationInput;
    let editDeceasedRemarksInput;
    let editDeceasedNotifyHundredInput, editDeceasedNotifyYear1Input, editDeceasedNotifyYear3Input;
    let editDeceasedAttendedHundredInput, editDeceasedAttendedYear1Input, editDeceasedAttendedYear3Input;
    let cancelEditButton, deleteDeceasedButton;
    let backButtonAdd, backButtonDetails;

    function setupDomRefs() {
      pageList = document.getElementById("page-list");
      pageAddDeceased = document.getElementById("page-add-deceased");
      pageDetails = document.getElementById("page-details");
      pageEditDeceased = document.getElementById("page-edit-deceased");

      deceasedList = document.getElementById("deceased-list");
      loadingIndicator = document.getElementById("loading-indicator");
      addDeceasedFab = document.getElementById("add-deceased-fab");
      exportButton = document.getElementById("export-button");
      exportLoadingIndicator = document.getElementById("export-loading-text");

      addDeceasedForm = document.getElementById("add-deceased-form");
      deceasedNameInput = document.getElementById("deceased-name");
      deceasedDateInput = document.getElementById("deceased-date");
      deceasedReferrerInput = document.getElementById("deceased-referrer");
      deceasedSourceSelect = document.getElementById("deceased-source");
      deceasedSourceNotesInput = document.getElementById("deceased-source-notes");
      deceasedApplicantNameInput = document.getElementById("deceased-applicant-name");
      deceasedApplicantRelInput = document.getElementById("deceased-applicant-relation");
      deceasedContactNameInput = document.getElementById("deceased-contact-name");
      deceasedContactRelInput = document.getElementById("deceased-contact-relation");
      deceasedContactPhoneInput = document.getElementById("deceased-contact-phone");
      deceasedChantDateInput = document.getElementById("deceased-chant-date");
      deceasedChantTimeInput = document.getElementById("deceased-chant-time");
      deceasedChantLocationInput = document.getElementById("deceased-chant-location");
      deceasedRemarksInput = document.getElementById("deceased-remarks");

      deceasedNotifyHundredInput = document.getElementById("deceased-notify-hundred");
      deceasedNotifyYear1Input = document.getElementById("deceased-notify-year1");
      deceasedNotifyYear3Input = document.getElementById("deceased-notify-year3");
      deceasedAttendedHundredInput = document.getElementById("deceased-attended-hundred");
      deceasedAttendedYear1Input = document.getElementById("deceased-attended-year1");
      deceasedAttendedYear3Input = document.getElementById("deceased-attended-year3");

      detailsDeceasedName = document.getElementById("details-deceased-name");
      detailsDeceasedDate = document.getElementById("details-deceased-date");
      detailsDeceasedReferrer = document.getElementById("details-deceased-referrer");
      detailsDeceasedSource = document.getElementById("details-deceased-source");
      detailsDeceasedSourceNotes = document.getElementById("details-deceased-source-notes");
      detailsApplicant = document.getElementById("details-applicant");
      detailsContact = document.getElementById("details-contact");
      detailsContactPhone = document.getElementById("details-contact-phone");
      detailsChantDateTime = document.getElementById("details-chant-date-time");
      detailsChantLocation = document.getElementById("details-chant-location");
      detailsRemarks = document.getElementById("details-remarks");
      detailsNotify = document.getElementById("details-notify");
      detailsAttended = document.getElementById("details-attended");
      editDeceasedButton = document.getElementById("edit-deceased-button");

      addAttendanceForm = document.getElementById("add-attendance-form");
      attendanceFamilyNameInput = document.getElementById("attendance-family-name");
      attendanceTypeSelect = document.getElementById("attendance-type");
      attendanceDateInput = document.getElementById("attendance-date");
      attendanceList = document.getElementById("attendance-list");

      editDeceasedForm = document.getElementById("edit-deceased-form");
      editDeceasedNameInput = document.getElementById("edit-deceased-name");
      editDeceasedDateInput = document.getElementById("edit-deceased-date");
      editDeceasedReferrerInput = document.getElementById("edit-deceased-referrer");
      editDeceasedSourceSelect = document.getElementById("edit-deceased-source");
      editDeceasedSourceNotesInput = document.getElementById("edit-deceased-source-notes");
      editDeceasedApplicantNameInput = document.getElementById("edit-deceased-applicant-name");
      editDeceasedApplicantRelInput = document.getElementById("edit-deceased-applicant-relation");
      editDeceasedContactNameInput = document.getElementById("edit-deceased-contact-name");
      editDeceasedContactRelInput = document.getElementById("edit-deceased-contact-relation");
      editDeceasedContactPhoneInput = document.getElementById("edit-deceased-contact-phone");
      editDeceasedChantDateInput = document.getElementById("edit-deceased-chant-date");
      editDeceasedChantTimeInput = document.getElementById("edit-deceased-chant-time");
      editDeceasedChantLocationInput = document.getElementById("edit-deceased-chant-location");
      editDeceasedRemarksInput = document.getElementById("edit-deceased-remarks");
      editDeceasedNotifyHundredInput = document.getElementById("edit-deceased-notify-hundred");
      editDeceasedNotifyYear1Input = document.getElementById("edit-deceased-notify-year1");
      editDeceasedNotifyYear3Input = document.getElementById("edit-deceased-notify-year3");
      editDeceasedAttendedHundredInput = document.getElementById("edit-deceased-attended-hundred");
      editDeceasedAttendedYear1Input = document.getElementById("edit-deceased-attended-year1");
      editDeceasedAttendedYear3Input = document.getElementById("edit-deceased-attended-year3");
      cancelEditButton = document.getElementById("cancel-edit-button");
      deleteDeceasedButton = document.getElementById("delete-deceased-button");

      backButtonAdd = document.getElementById("back-button-add");
      backButtonDetails = document.getElementById("back-button-details");
    }

    /**************************************************************
     * 7) 事件綁定（保留返回按鈕修復；不動其他流程）
     **************************************************************/
    function navigateTo(pageId) {
      [pageList, pageAddDeceased, pageDetails, pageEditDeceased].forEach(page => {
        if (!page) return;
        if (page.id === pageId) page.classList.remove("hidden-page");
        else page.classList.add("hidden-page");
      });
    }
    function setupEventListeners() {
      addDeceasedFab?.addEventListener("click", () => {
        if (!currentUserId) return showCustomAlert("未登入狀態無法新增。");
        addDeceasedForm.reset();
        navigateTo("page-add-deceased");
      });
      exportButton?.addEventListener("click", async () => {
        if (!currentUserId) return showCustomAlert("請先登入");
        if (await showCustomConfirm("您確定要匯出所有資料嗎？")) {
          exportLoadingIndicator.classList.remove("hidden-page");
          try {
            await exportAllData();
            showCustomAlert("資料匯出成功！已下載 JSON 備份檔。");
          } catch (e) {
            console.error("[export] 失敗：", e);
            showCustomAlert("匯出失敗，請檢查網路連線。");
          } finally {
            exportLoadingIndicator.classList.add("hidden-page");
          }
        }
      });
      addDeceasedForm?.addEventListener("submit", handleAddDeceased);
      editDeceasedButton?.addEventListener("click", loadEditForm);
      addAttendanceForm?.addEventListener("submit", handleAddAttendance);
      editDeceasedForm?.addEventListener("submit", handleEditDeceased);
      cancelEditButton?.addEventListener("click", () => navigateTo("page-details"));
      deleteDeceasedButton?.addEventListener("click", handleDeleteDeceased);
      backButtonAdd?.addEventListener("click", () => navigateTo("page-list"));
      backButtonDetails?.addEventListener("click", () => navigateTo("page-list"));
    }

    /**************************************************************
     * 8) 主列表（依「往生日期」由新到舊排序）
     **************************************************************/
    let firstListSnap = true;
    async function loadDeceasedList() {
      if (!currentUserId) return;
      loadingIndicator.classList.remove("hidden-page");
      deceasedList.innerHTML = "";
      if (deceasedUnsubscribe) deceasedUnsubscribe();

      const qy = query(collection(db, getDeceasedCollectionPath()));
      deceasedUnsubscribe = onSnapshot(qy, (snap) => {
        loadingIndicator.classList.add("hidden-page");
        if (firstListSnap) {
          setConnDot("ok", "已連線到 Firestore（收到列表更新）");
          firstListSnap = false;
        }
        if (snap.empty) {
          deceasedList.innerHTML = '<p class="text-gray-500 text-center col-span-1 md:col-span-2 lg:col-span-3">目前沒有任何資料。請點擊右下角按鈕新增。</p>';
          return;
        }
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a, b) => {
            const da = a.deceasedDate ? new Date(a.deceasedDate) : new Date(0);
            const dbb = b.deceasedDate ? new Date(b.deceasedDate) : new Date(0);
            return dbb - da;
          });
        renderDeceasedCards(docs, /*interactive=*/true);
      }, (err) => {
        console.error("[list] 讀取失敗：", err);
        setChip("讀取失敗", "err");
        setConnDot("err", "列表讀取失敗");
        loadingIndicator.classList.add("hidden-page");
        deceasedList.innerHTML = '<p class="text-red-500 text-center col-span-1 md:col-span-2 lg:col-span-3">資料加載失敗，請檢查網路連線。</p>';
      });
    }

    function renderDeceasedCards(docs, interactive) {
      deceasedList.innerHTML = "";
      docs.forEach(data => {
        const el = document.createElement("div");
        el.className = "bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow" + (interactive ? " cursor-pointer" : " opacity-90");
        el.innerHTML = `
          <h3 class="text-lg font-semibold text-teal-700">${data.name}</h3>
          <p class="text-sm text-gray-600">往生日期：${data.deceasedDate || "未填寫"}</p>
          ${data.contactName ? `<p class="text-sm text-gray-600">聯絡人：${data.contactName}（${data.contactRelation || "?"}）</p>` : ""}
          ${data.contactPhone ? `<p class="text-sm text-gray-600">電話：${data.contactPhone}</p>` : ""}
        `;
        if (interactive) {
          el.addEventListener("click", () => {
            currentDeceasedId = data.id;
            loadDeceasedDetails(currentDeceasedId);
            navigateTo("page-details");
          });
        }
        deceasedList.appendChild(el);
      });
    }

    async function loadDeceasedDetails(id) {
      try {
        const snap = await getDoc(doc(db, getDeceasedCollectionPath(), id));
        if (!snap.exists()) {
          showCustomAlert("找不到資料，可能已被刪除。");
          return navigateTo("page-list");
        }
        const d = snap.data();
        detailsDeceasedName.textContent = d.name || "N/A";
        detailsDeceasedDate.textContent = `往生日期：${d.deceasedDate || "N/A"}`;

        detailsApplicant.textContent = (d.applicantName || d.applicantRelation) ? `申請人：${d.applicantName || ""}（${d.applicantRelation || "?"}）` : "";
        detailsContact.textContent = (d.contactName || d.contactRelation) ? `聯絡人：${d.contactName || ""}（${d.contactRelation || "?"}）` : "";
        detailsContactPhone.textContent = d.contactPhone ? `聯絡電話：${d.contactPhone}` : "";
        detailsChantDateTime.textContent = (d.chantDate || d.chantTime) ? `助念時間：${(d.chantDate || "")} ${(d.chantTime || "")}`.trim() : "";
        detailsChantLocation.textContent = d.chantLocation ? `助念地點：${d.chantLocation}` : "";

        detailsDeceasedReferrer.textContent = d.referrer ? `介紹人：${d.referrer}` : "";
        detailsDeceasedSource.textContent = d.source ? `如何得知：${d.source}` : "";
        detailsDeceasedSourceNotes.textContent = d.sourceNotes ? `↳ 說明：${d.sourceNotes}` : "";
        detailsRemarks.textContent = d.remarks ? `備註：${d.remarks}` : "";

        const notify = [];
        if (d.notifyHundred) notify.push("百日");
        if (d.notifyYear1) notify.push("對年");
        if (d.notifyYear3) notify.push("三年");
        detailsNotify.textContent = notify.length ? `通知項目：${notify.join("、")}` : "";

        const attended = [];
        if (d.attendedHundred) attended.push("百日");
        if (d.attendedYear1) attended.push("對年");
        if (d.attendedYear3) attended.push("三年");
        detailsAttended.textContent = attended.length ? `已參與：${attended.join("、")}` : "";

        [detailsApplicant, detailsContact, detailsContactPhone, detailsChantDateTime, detailsChantLocation,
         detailsDeceasedReferrer, detailsDeceasedSource, detailsDeceasedSourceNotes, detailsRemarks, detailsNotify, detailsAttended
        ].forEach(el => {
          if (!el) return;
          if (!el.textContent || el.textContent.trim() === "") el.classList.add("hidden-page");
          else el.classList.remove("hidden-page");
        });

        loadAttendanceList(id);
      } catch (e) {
        console.error("[details] 讀取失敗：", e);
        setChip("讀取失敗", "err");
        setConnDot("err", "詳細資料讀取失敗");
        showCustomAlert("加載詳細資料失敗。");
      }
    }

    /**************************************************************
     * 9) CRUD：新增/修改/刪除（含做七登記）
     **************************************************************/
    async function handleAddDeceased(e) {
      e.preventDefault();
      if (!currentUserId || !deceasedNameInput.value || !deceasedDateInput.value) {
        return showCustomAlert("請（登入後）填寫菩薩姓名和往生日期。");
      }
      const payload = {
        name: deceasedNameInput.value,
        deceasedDate: deceasedDateInput.value,
        referrer: deceasedReferrerInput.value || "",
        source: deceasedSourceSelect.value || "",
        sourceNotes: deceasedSourceNotesInput.value || "",
        applicantName: deceasedApplicantNameInput.value || "",
        applicantRelation: deceasedApplicantRelInput.value || "",
        contactName: deceasedContactNameInput.value || "",
        contactRelation: deceasedContactRelInput.value || "",
        contactPhone: deceasedContactPhoneInput.value || "",
        chantDate: deceasedChantDateInput.value || "",
        chantTime: deceasedChantTimeInput.value || "",
        chantLocation: deceasedChantLocationInput.value || "",
        remarks: deceasedRemarksInput.value || "",
        notifyHundred: !!deceasedNotifyHundredInput.checked,
        notifyYear1: !!deceasedNotifyYear1Input.checked,
        notifyYear3: !!deceasedNotifyYear3Input.checked,
        attendedHundred: !!deceasedAttendedHundredInput.checked,
        attendedYear1: !!deceasedAttendedYear1Input.checked,
        attendedYear3: !!deceasedAttendedYear3Input.checked,
        createdAt: new Date().toISOString(),
        createdBy: currentUserId
      };
      try {
        const ref = await addDoc(collection(db, getDeceasedCollectionPath()), payload);
        currentDeceasedId = ref.id;
        await loadDeceasedDetails(currentDeceasedId);
        addDeceasedForm.reset();
        navigateTo("page-details");
      } catch (e) {
        console.error("[add] 新增失敗：", e);
        showCustomAlert("新增資料失敗，請檢查網路。");
      }
    }

    async function loadEditForm() {
      if (!currentDeceasedId) return;
      if (!currentUserId) return showCustomAlert("未登入狀態不可修改。");
      try {
        const snap = await getDoc(doc(db, getDeceasedCollectionPath(), currentDeceasedId));
        if (!snap.exists()) {
          showCustomAlert("找不到資料，可能已被刪除。");
          return navigateTo("page-list");
        }
        const d = snap.data();
        editDeceasedNameInput.value = d.name || "";
        editDeceasedDateInput.value = d.deceasedDate || "";
        editDeceasedReferrerInput.value = d.referrer || "";
        editDeceasedSourceSelect.value = d.source || "";
        editDeceasedSourceNotesInput.value = d.sourceNotes || "";
        editDeceasedApplicantNameInput.value = d.applicantName || "";
        editDeceasedApplicantRelInput.value = d.applicantRelation || "";
        editDeceasedContactNameInput.value = d.contactName || "";
        editDeceasedContactRelInput.value = d.contactRelation || "";
        editDeceasedContactPhoneInput.value = d.contactPhone || "";
        editDeceasedChantDateInput.value = d.chantDate || "";
        editDeceasedChantTimeInput.value = d.chantTime || "";
        editDeceasedChantLocationInput.value = d.chantLocation || "";
        editDeceasedRemarksInput.value = d.remarks || "";
        editDeceasedNotifyHundredInput.checked = !!d.notifyHundred;
        editDeceasedNotifyYear1Input.checked = !!d.notifyYear1;
        editDeceasedNotifyYear3Input.checked = !!d.notifyYear3;
        editDeceasedAttendedHundredInput.checked = !!d.attendedHundred;
        editDeceasedAttendedYear1Input.checked = !!d.attendedYear1;
        editDeceasedAttendedYear3Input.checked = !!d.attendedYear3;
        navigateTo("page-edit-deceased");
      } catch (e) {
        console.error("[edit/load] 失敗：", e);
        showCustomAlert("加載資料失敗。");
      }
    }

    async function handleEditDeceased(e) {
      e.preventDefault();
      if (!currentDeceasedId || !currentUserId) return showCustomAlert("未登入或無效 ID。");
      const payload = {
        name: editDeceasedNameInput.value,
        deceasedDate: editDeceasedDateInput.value,
        referrer: editDeceasedReferrerInput.value || "",
        source: editDeceasedSourceSelect.value || "",
        sourceNotes: editDeceasedSourceNotesInput.value || "",
        applicantName: editDeceasedApplicantNameInput.value || "",
        applicantRelation: editDeceasedApplicantRelInput.value || "",
        contactName: editDeceasedContactNameInput.value || "",
        contactRelation: editDeceasedContactRelInput.value || "",
        contactPhone: editDeceasedContactPhoneInput.value || "",
        chantDate: editDeceasedChantDateInput.value || "",
        chantTime: editDeceasedChantTimeInput.value || "",
        chantLocation: editDeceasedChantLocationInput.value || "",
        remarks: editDeceasedRemarksInput.value || "",
        notifyHundred: !!editDeceasedNotifyHundredInput.checked,
        notifyYear1: !!editDeceasedNotifyYear1Input.checked,
        notifyYear3: !!editDeceasedNotifyYear3Input.checked,
        attendedHundred: !!editDeceasedAttendedHundredInput.checked,
        attendedYear1: !!editDeceasedAttendedYear1Input.checked,
        attendedYear3: !!editDeceasedAttendedYear3Input.checked
      };
      try {
        await updateDoc(doc(db, getDeceasedCollectionPath(), currentDeceasedId), payload);
        await loadDeceasedDetails(currentDeceasedId);
        navigateTo("page-details");
      } catch (e) {
        console.error("[edit] 失敗：", e);
        showCustomAlert("修改資料失敗，請檢查網路。");
      }
    }

    async function handleDeleteDeceased() {
      if (!currentDeceasedId || !currentUserId) return showCustomAlert("未登入狀態不可刪除。");
      const ok = await showCustomConfirm("您確定要永久刪除此筆檔案嗎？\\n\\n所有相關的「做七紀錄」將會一併刪除。此操作無法復原。");
      if (!ok) return;
      try {
        const did = currentDeceasedId;
        const attSnap = await getDocs(collection(db, getAttendanceCollectionPath(did)));
        const jobs = [];
        attSnap.forEach(d => jobs.push(deleteDoc(d.ref)));
        await Promise.all(jobs);
        await deleteDoc(doc(db, getDeceasedCollectionPath(), did));
        currentDeceasedId = null;
        navigateTo("page-list");
        showCustomAlert("檔案已成功刪除。");
      } catch (e) {
        console.error("[delete] 失敗：", e);
        showCustomAlert("刪除失敗，請檢查網路連線。");
      }
    }

    async function handleAddAttendance(e) {
      e.preventDefault();
      if (!currentDeceasedId) return;
      if (!currentUserId) return showCustomAlert("未登入狀態不可登記。");
      const name = (attendanceFamilyNameInput.value || "").trim();
      if (!name || !attendanceTypeSelect.value || !attendanceDateInput.value) {
        return showCustomAlert("請填寫出席者姓名、七旬類別與日期。");
      }
      const payload = { familyName: name, type: attendanceTypeSelect.value, date: attendanceDateInput.value, createdAt: new Date().toISOString() };
      try {
        await addDoc(collection(db, getAttendanceCollectionPath(currentDeceasedId)), payload);
        addAttendanceForm.reset();
        attendanceFamilyNameInput.value = "家屬";
      } catch (e) {
        console.error("[attendance/add] 失敗：", e);
        showCustomAlert("登記失敗。");
      }
    }

    function loadAttendanceList(deceasedId) {
      if (attendanceUnsubscribe) attendanceUnsubscribe();
      const qy = query(collection(db, getAttendanceCollectionPath(deceasedId)));
      attendanceUnsubscribe = onSnapshot(qy, (snap) => {
        attendanceList.innerHTML = "";
        if (snap.empty) {
          attendanceList.innerHTML = '<p class="text-gray-500">尚無做七登記紀錄。</p>';
          return;
        }
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a, b) => {
            const da = a.date ? new Date(a.date) : new Date(0);
            const dbb = b.date ? new Date(b.date) : new Date(0);
            return dbb - da;
          });
        docs.forEach(row => {
          const li = document.createElement("li");
          li.className = "flex justify-between items-center p-2 border-b";
          li.innerHTML = `
            <span><strong>${row.type}</strong> - ${row.familyName || "（未填姓名）"} - ${row.date}</span>
            <button class="text-red-500 hover:text-red-700 text-sm" data-id="${row.id}">刪除</button>
          `;
          li.querySelector("button").addEventListener("click", async () => {
            if (!currentUserId) return showCustomAlert("未登入狀態不可刪除。");
            if (await showCustomConfirm(\`您確定要刪除這筆「\${row.type}」紀錄嗎？\`)) {
              try {
                await deleteDoc(doc(db, getAttendanceCollectionPath(deceasedId), row.id));
              } catch (e) {
                console.error("[attendance/delete] 失敗：", e);
                showCustomAlert("刪除失敗。");
              }
            }
          });
          attendanceList.appendChild(li);
        });
      }, (e) => {
        console.error("[attendance/list] 失敗：", e);
        attendanceList.innerHTML = '<p class="text-red-500">登記列表加載失敗。</p>';
      });
    }

    /**************************************************************
     * 10) 匯出
     **************************************************************/
    async function exportAllData() {
      if (!currentUserId) throw new Error("未登入");
      const exportData = { appId, exportDate: new Date().toISOString(), deceased: [] };
      const snap = await getDocs(collection(db, getDeceasedCollectionPath()));
      for (const d of snap.docs) {
        const base = { id: d.id, data: d.data(), attendance: [] };
        const attSnap = await getDocs(collection(db, getAttendanceCollectionPath(d.id)));
        attSnap.forEach(a => base.attendance.push({ id: a.id, data: a.data() }));
        exportData.deceased.push(base);
      }
      const dateStr = new Date().toISOString().split("T")[0];
      const fileName = `doingSeven-backup-${dateStr}.json`;
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: "application/json;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    /**************************************************************
     * 11) 自動「連線測試」：讀取一次（頁面載入即執行）
     **************************************************************/
    async function testConnectionOnce() {
      try {
        const snap = await getDocs(collection(db, getDeceasedCollectionPath()));
        setConnDot("ok", "測試：成功讀取 Firestore");
        if (!snap || snap.empty) {
          // 雖然為空，也代表連線成功，只是沒有資料
          setConnDot("ok", "已連線（目前資料為空）");
        }
      } catch (e) {
        setChip(`測試讀取失敗：${e?.message || e}`, "err");
        setConnDot("err", "測試讀取失敗");
      }
    }

    /**************************************************************
     * 12) 自訂 Alert / Confirm
     **************************************************************/
    function showCustomAlert(message) {
      const box = document.getElementById("custom-alert");
      const msg = document.getElementById("custom-alert-message");
      const ok = document.getElementById("custom-alert-ok");
      msg.textContent = message;
      box.classList.remove("hidden-page");
      const newOk = ok.cloneNode(true);
      ok.parentNode.replaceChild(newOk, ok);
      newOk.addEventListener("click", () => box.classList.add("hidden-page"));
    }
    function showCustomConfirm(message) {
      const box = document.getElementById("custom-confirm");
      const msg = document.getElementById("custom-confirm-message");
      const yes = document.getElementById("custom-confirm-yes");
      const no = document.getElementById("custom-confirm-no");
      msg.textContent = message;
      box.classList.remove("hidden-page");
      return new Promise((resolve) => {
        const newYes = yes.cloneNode(true);
        yes.parentNode.replaceChild(newYes, yes);
        const newNo = no.cloneNode(true);
        no.parentNode.replaceChild(newNo, no);
        newYes.addEventListener("click", () => { box.classList.add("hidden-page"); resolve(true); });
        newNo.addEventListener("click", () => { box.classList.add("hidden-page"); resolve(false); });
      });
    }
  </script>
</head>

<body class="bg-gray-100 font-sans">
  <div class="container mx-auto max-w-4xl min-h-screen bg-gray-100">

    <!-- =======================
         頁面 1: 往生菩薩列表（含常駐小綠燈）
    ========================= -->
    <main id="page-list" class="p-4">
      <header class="bg-teal-700 text-white shadow-md rounded-t-lg p-4 sticky top-0 z-10">
        <h1 class="text-2xl font-semibold text-center">
          <span id="conn-dot" class="conn-dot bg-amber-500 mr-2" title="啟動中…"></span>
          往生菩薩
        </h1>
      </header>

      <div id="loading-indicator" class="text-center p-8 hidden-page">
        <p class="text-gray-500">正在從雲端讀取資料...</p>
      </div>

      <div id="deceased-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
        <!-- Cards 由 JS 動態插入 -->
      </div>

      <!-- 右下角浮動新增按鈕（保留原有行為；如無此按鈕可忽略） -->
      <button id="add-deceased-fab" class="fixed bottom-6 right-6 bg-teal-600 text-white w-12 h-12 rounded-full text-2xl leading-[3rem] shadow-lg hover:bg-teal-700">
        +
      </button>

      <!-- 左下角「匯出」按鈕（若前版已有則保留） -->
      <button id="export-button" class="fixed bottom-6 left-6 bg-slate-600 text-white px-4 py-2 rounded shadow-md hover:bg-slate-700">
        匯出
      </button>
      <span id="export-loading-text" class="fixed bottom-6 left-28 text-xs text-gray-400 hidden-page">匯出中…</span>
    </main>

    <!-- =======================
         頁面 2: 新增往生菩薩
    ========================= -->
    <main id="page-add-deceased" class="p-4 hidden-page">
      <header class="bg-teal-700 text-white shadow-md rounded-t-lg p-4 sticky top-0 z-10 flex items-center">
        <button id="back-button-add" class="text-white mr-4">&larr; 返回</button>
        <h2 class="text-2xl font-semibold">新增菩薩檔案</h2>
      </header>

      <form id="add-deceased-form" class="space-y-4 bg-white p-4 rounded-b-lg shadow-md">
        <h3 class="text-lg font-semibold border-b pb-2 text-teal-700">基本資料</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="deceased-name" class="block text-sm font-medium text-gray-700">往生菩薩姓名 <span class="text-red-500">*</span></label>
            <input type="text" id="deceased-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="deceased-date" class="block text-sm font-medium text-gray-700">往生日期 <span class="text-red-500">*</span></label>
            <input type="date" id="deceased-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
        </div>

        <h3 class="text-lg font-semibold border-b pb-2 text-teal-700 pt-4">助念服務資料 (告別式前)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="deceased-applicant-name" class="block text-sm font-medium text-gray-700">申請人 (選填)</label>
            <input type="text" id="deceased-applicant-name" placeholder="姓名" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="deceased-applicant-relation" class="block text-sm font-medium text-gray-700">關係 (選填)</label>
            <input type="text" id="deceased-applicant-relation" placeholder="例如：兒子" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="deceased-contact-name" class="block text-sm font-medium text-gray-700">聯絡人 (選填)</label>
            <input type="text" id="deceased-contact-name" placeholder="姓名" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="deceased-contact-relation" class="block text-sm font-medium text-gray-700">關係 (選填)</label>
            <input type="text" id="deceased-contact-relation" placeholder="例如：媳婦" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="deceased-chant-date" class="block text-sm font-medium text-gray-700">助念日期 (選填)</label>
            <input type="date" id="deceased-chant-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="deceased-chant-time" class="block text-sm font-medium text-gray-700">助念時間 (選填)</label>
            <input type="time" id="deceased-chant-time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
        </div>
        <div>
          <label for="deceased-contact-phone" class="block text-sm font-medium text-gray-700">聯絡電話 (選填)</label>
          <input type="tel" id="deceased-contact-phone" placeholder="電話號碼" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
        </div>
        <div>
          <label for="deceased-chant-location" class="block text-sm font-medium text-gray-700">助念地點 (選填)</label>
          <input type="text" id="deceased-chant-location" placeholder="例如：自宅 或 XX 殯儀館" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
        </div>

        <h3 class="text-lg font-semibold border-b pb-2 text-teal-700 pt-4">後續關懷 (選填)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">是否通知 (可複選)</label>
            <div class="flex items-center"><input type="checkbox" id="deceased-notify-hundred" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="deceased-notify-hundred" class="ml-2 block text-sm text-gray-900">通知百日</label></div>
            <div class="flex items-center"><input type="checkbox" id="deceased-notify-year1" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="deceased-notify-year1" class="ml-2 block text-sm text-gray-900">通知對年</label></div>
            <div class="flex items-center"><input type="checkbox" id="deceased-notify-year3" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="deceased-notify-year3" class="ml-2 block text-sm text-gray-900">通知三年</label></div>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">是否已回來參與 (可複選)</label>
            <div class="flex items-center"><input type="checkbox" id="deceased-attended-hundred" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="deceased-attended-hundred" class="ml-2 block text-sm text-gray-900">已參與百日</label></div>
            <div class="flex items-center"><input type="checkbox" id="deceased-attended-year1" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="deceased-attended-year1" class="ml-2 block text-sm text-gray-900">已參與對年</label></div>
            <div class="flex items-center"><input type="checkbox" id="deceased-attended-year3" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="deceased-attended-year3" class="ml-2 block text-sm text-gray-900">已參與三年</label></div>
          </div>
        </div>

        <h3 class="text-lg font-semibold border-b pb-2 text-teal-700 pt-4">來源資料</h3>
        <div>
          <label for="deceased-referrer" class="block text-sm font-medium text-gray-700">介紹人 (選填)</label>
          <input type="text" id="deceased-referrer" placeholder="例如：王師兄" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
        </div>
        <div>
          <label for="deceased-source" class="block text-sm font-medium text-gray-700">如何得知 (選填)</label>
          <select id="deceased-source" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
            <option value="">-- 請選擇 --</option>
            <option value="網路搜尋">網路搜尋</option>
            <option value="社群媒體 (FB/Line)">社群媒體 (FB/Line)</option>
            <option value="親友/蓮友介紹">親友/蓮友介紹</option>
            <option value="家屬曾參與過">家屬曾參與過</option>
            <option value="其他分會">其他分會</option>
            <option value="其他道場">其他道場</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <div>
          <label for="deceased-source-notes" class="block text-sm font-medium text-gray-700">說明 (選填)</label>
          <textarea id="deceased-source-notes" rows="3" placeholder="例如：介紹人姓名、或[其他]的具體內容..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
        </div>
        <div>
          <label for="deceased-remarks" class="block text-sm font-medium text-gray-700">備註 (選填)</label>
          <textarea id="deceased-remarks" rows="3" placeholder="任何需要補充的資訊..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
        </div>

        <button type="submit" class="w-full bg-teal-600 text-white py-3 px-4 rounded-md font-semibold hover:bg-teal-700 transition duration-200 text-lg">儲存檔案</button>
      </form>
    </main>

    <!-- =======================
         頁面 3: 詳細管理頁（資訊卡 + 登記表 + 列表）
    ========================= -->
    <main id="page-details" class="p-4 hidden-page">
      <header class="bg-teal-700 text-white shadow-md rounded-t-lg p-4 sticky top-0 z-10 flex items-center justify-between">
        <button id="back-button-details" class="text-white mr-4">&larr; 返回列表</button>
        <h2 class="text-2xl font-semibold">詳細資料</h2>
        <button id="edit-deceased-button" class="text-white text-sm">修改</button>
      </header>

      <div class="bg-white p-4 rounded-b-lg shadow-md mb-4 space-y-2">
        <h3 id="details-deceased-name" class="text-2xl font-bold text-teal-800"></h3>
        <p id="details-deceased-date" class="text-gray-600"></p>

        <div class="pt-2 border-t">
          <p id="details-applicant" class="text-sm text-gray-600"></p>
          <p id="details-contact" class="text-sm text-gray-600"></p>
          <p id="details-contact-phone" class="text-sm text-gray-600"></p>
          <p id="details-chant-date-time" class="text-sm text-gray-600"></p>
          <p id="details-chant-location" class="text-sm text-gray-600"></p>
        </div>

        <div class="pt-2 border-t">
          <p id="details-deceased-referrer" class="text-sm text-gray-500"></p>
          <p id="details-deceased-source" class="text-sm text-gray-500"></p>
          <p id="details-deceased-source-notes" class="text-sm text-gray-500 pl-4"></p>
        </div>

        <div class="pt-2 border-t">
          <p id="details-notify" class="text-sm text-gray-600 font-medium"></p>
          <p id="details-attended" class="text-sm text-gray-600 font-medium"></p>
          <p id="details-remarks" class="text-sm text-gray-600 whitespace-pre-wrap"></p>
        </div>
      </div>

      <!-- 登記做七 -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-4">
        <h3 class="font-semibold mb-3">登記做七</h3>
        <form id="add-attendance-form" class="space-y-3 mb-4">
          <input type="text" id="attendance-family-name" value="家屬" placeholder="出席者姓名（預設：家屬）" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          <select id="attendance-type" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
            <option value="">-- 選擇七旬 --</option>
            <option value="頭七">頭七</option>
            <option value="二七">二七</option>
            <option value="三七">三七</option>
            <option value="四七">四七</option>
            <option value="五七">五七</option>
            <option value="六七">六七</option>
            <option value="滿七">滿七</option>
            <option value="百日">百日</option>
            <option value="其他">其他</option>
          </select>
          <input type="date" id="attendance-date" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          <button type="submit" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-teal-700 transition duration-200">登記出席</button>
        </form>
        <h3 class="font-semibold mb-2">登記列表（最新在最前）</h3>
        <ul id="attendance-list" class="divide-y divide-gray-200"></ul>
      </div>
    </main>

    <!-- =======================
         頁面 4: 修改菩薩檔案
    ========================= -->
    <main id="page-edit-deceased" class="p-4 hidden-page">
      <header class="bg-teal-700 text-white shadow-md rounded-t-lg p-4 sticky top-0 z-10 flex items-center">
        <h2 class="text-2xl font-semibold">修改菩薩檔案</h2>
      </header>

      <form id="edit-deceased-form" class="space-y-4 bg-white p-4 rounded-b-lg shadow-md">
        <h3 class="text-lg font-semibold border-b pb-2 text-teal-700">基本資料</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="edit-deceased-name" class="block text-sm font-medium text-gray-700">往生菩薩姓名 <span class="text-red-500">*</span></label>
            <input type="text" id="edit-deceased-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="edit-deceased-date" class="block text-sm font-medium text-gray-700">往生日期 <span class="text-red-500">*</span></label>
            <input type="date" id="edit-deceased-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
        </div>

        <h3 class="text-lg font-semibold border-b pb-2 text-teal-700 pt-4">助念服務資料 (告別式前)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="edit-deceased-applicant-name" class="block text-sm font-medium text-gray-700">申請人 (選填)</label>
            <input type="text" id="edit-deceased-applicant-name" placeholder="姓名" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="edit-deceased-applicant-relation" class="block text-sm font-medium text-gray-700">關係 (選填)</label>
            <input type="text" id="edit-deceased-applicant-relation" placeholder="例如：兒子" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="edit-deceased-contact-name" class="block text-sm font-medium text-gray-700">聯絡人 (選填)</label>
            <input type="text" id="edit-deceased-contact-name" placeholder="姓名" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="edit-deceased-contact-relation" class="block text-sm font-medium text-gray-700">關係 (選填)</label>
            <input type="text" id="edit-deceased-contact-relation" placeholder="例如：媳婦" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="edit-deceased-chant-date" class="block text-sm font-medium text-gray-700">助念日期 (選填)</label>
            <input type="date" id="edit-deceased-chant-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
          <div>
            <label for="edit-deceased-chant-time" class="block text-sm font-medium text-gray-700">助念時間 (選填)</label>
            <input type="time" id="edit-deceased-chant-time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
          </div>
        </div>
        <div>
          <label for="edit-deceased-contact-phone" class="block text-sm font-medium text-gray-700">聯絡電話 (選填)</label>
          <input type="tel" id="edit-deceased-contact-phone" placeholder="電話號碼" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
        </div>
        <div>
          <label for="edit-deceased-chant-location" class="block text-sm font-medium text-gray-700">助念地點 (選填)</label>
          <input type="text" id="edit-deceased-chant-location" placeholder="例如：自宅 或 XX 殯儀館" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
        </div>

        <h3 class="text-lg font-semibold border-b pb-2 text-teal-700 pt-4">後續關懷 (選填)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">是否通知 (可複選)</label>
            <div class="flex items-center"><input type="checkbox" id="edit-deceased-notify-hundred" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="edit-deceased-notify-hundred" class="ml-2 block text-sm text-gray-900">通知百日</label></div>
            <div class="flex items-center"><input type="checkbox" id="edit-deceased-notify-year1" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="edit-deceased-notify-year1" class="ml-2 block text-sm text-gray-900">通知對年</label></div>
            <div class="flex items-center"><input type="checkbox" id="edit-deceased-notify-year3" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="edit-deceased-notify-year3" class="ml-2 block text-sm text-gray-900">通知三年</label></div>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">是否已回來參與 (可複選)</label>
            <div class="flex items-center"><input type="checkbox" id="edit-deceased-attended-hundred" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="edit-deceased-attended-hundred" class="ml-2 block text-sm text-gray-900">已參與百日</label></div>
            <div class="flex items-center"><input type="checkbox" id="edit-deceased-attended-year1" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="edit-deceased-attended-year1" class="ml-2 block text-sm text-gray-900">已參與對年</label></div>
            <div class="flex items-center"><input type="checkbox" id="edit-deceased-attended-year3" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="edit-deceased-attended-year3" class="ml-2 block text-sm text-gray-900">已參與三年</label></div>
          </div>
        </div>

        <h3 class="text-lg font-semibold border-b pb-2 text-teal-700 pt-4">來源資料</h3>
        <div>
          <label for="edit-deceased-referrer" class="block text-sm font-medium text-gray-700">介紹人 (選填)</label>
          <input type="text" id="edit-deceased-referrer" placeholder="例如：王師兄" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
        </div>
        <div>
          <label for="edit-deceased-source" class="block text-sm font-medium text-gray-700">如何得知 (選填)</label>
          <select id="edit-deceased-source" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
            <option value="">-- 請選擇 --</option>
            <option value="網路搜尋">網路搜尋</option>
            <option value="社群媒體 (FB/Line)">社群媒體 (FB/Line)</option>
            <option value="親友/蓮友介紹">親友/蓮友介紹</option>
            <option value="家屬曾參與過">家屬曾參與過</option>
            <option value="其他分會">其他分會</option>
            <option value="其他道場">其他道場</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <div>
          <label for="edit-deceased-source-notes" class="block text-sm font-medium text-gray-700">說明 (選填)</label>
          <textarea id="edit-deceased-source-notes" rows="3" placeholder="例如：介紹人姓名、或[其他]的具體內容..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
        </div>
        <div>
          <label for="edit-deceased-remarks" class="block text-sm font-medium text-gray-700">備註 (選填)</label>
          <textarea id="edit-deceased-remarks" rows="3" placeholder="任何需要補充的資訊..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
        </div>

        <div class="flex items-center gap-3 pt-2">
          <button type="submit" class="bg-teal-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-teal-700 transition duration-200">儲存修改</button>
          <button type="button" id="cancel-edit-button" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">取消</button>
          <button type="button" id="delete-deceased-button" class="ml-auto bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">刪除檔案</button>
        </div>
      </form>
    </main>

    <!-- 自訂 Alert -->
    <div id="custom-alert" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden-page">
      <div class="bg-white rounded shadow p-4 w-[90%] max-w-md">
        <div id="custom-alert-message" class="text-gray-800 whitespace-pre-wrap"></div>
        <div class="text-right mt-4">
          <button id="custom-alert-ok" class="px-4 py-2 bg-teal-600 text-white rounded">確定</button>
        </div>
      </div>
    </div>
    <!-- 自訂 Confirm -->
    <div id="custom-confirm" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden-page">
      <div class="bg-white rounded shadow p-4 w-[90%] max-w-md">
        <div id="custom-confirm-message" class="text-gray-800 whitespace-pre-wrap"></div>
        <div class="text-right mt-4 space-x-2">
          <button id="custom-confirm-no" class="px-4 py-2 bg-gray-200 text-gray-700 rounded">取消</button>
          <button id="custom-confirm-yes" class="px-4 py-2 bg-teal-600 text-white rounded">確定</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
